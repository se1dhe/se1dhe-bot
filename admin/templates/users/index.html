{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - SE1DHE Bot Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mt-4">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
    <div class="input-group" style="max-width: 300px;">
        <input type="text" class="form-control" id="search-user" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...">
        <div class="input-group-append">
            <button class="btn btn-primary" type="button" id="search-button">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">–§–∏–ª—å—Ç—Ä—ã</h6>
            </div>
            <div class="card-body">
                <form id="filter-form" class="row">
                    <div class="col-md-4 mb-3">
                        <label for="filter-language">–Ø–∑—ã–∫</label>
                        <select class="form-control" id="filter-language">
                            <option value="">–í—Å–µ —è–∑—ã–∫–∏</option>
                            <option value="ru">–†—É—Å—Å–∫–∏–π üá∑üá∫</option>
                            <option value="uk">–£–∫—Ä–∞–∏–Ω—Å–∫–∏–π üá∫üá¶</option>
                            <option value="en">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π üá¨üáß</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="filter-status">–°—Ç–∞—Ç—É—Å</label>
                        <select class="form-control" id="filter-status">
                            <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                            <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                            <option value="with_orders">–° –∑–∞–∫–∞–∑–∞–º–∏</option>
                            <option value="no_orders">–ë–µ–∑ –∑–∞–∫–∞–∑–æ–≤</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="filter-sort">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                        <select class="form-control" id="filter-sort">
                            <option value="newest">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                            <option value="oldest">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                            <option value="orders">–ü–æ –∫–æ–ª-–≤—É –∑–∞–∫–∞–∑–æ–≤</option>
                            <option value="name">–ü–æ –∏–º–µ–Ω–∏</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                        </button>
                        <button type="button" id="reset-filters" class="btn btn-outline-secondary">
                            <i class="fas fa-undo"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 mb-3">
                        <h5 class="text-muted">–í—Å–µ–≥–æ</h5>
                        <h2 id="total-users">...</h2>
                    </div>
                    <div class="col-6 mb-3">
                        <h5 class="text-muted">–° –∑–∞–∫–∞–∑–∞–º–∏</h5>
                        <h2 id="users-with-orders">...</h2>
                    </div>
                </div>

                <h6 class="text-muted">–Ø–∑—ã–∫–∏</h6>
                <div class="progress mb-3" style="height: 24px;">
                    <div class="progress-bar" id="lang-ru" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0% üá∑üá∫</div>
                    <div class="progress-bar bg-success" id="lang-uk" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0% üá∫üá¶</div>
                    <div class="progress-bar bg-info" id="lang-en" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0% üá¨üáß</div>
                    <div class="progress-bar bg-secondary" id="lang-other" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0% üåê</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="users-table" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Telegram ID</th>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                        <th>–Ø–∑—ã–∫</th>
                        <th>–ó–∞–∫–∞–∑—ã</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center" id="pagination">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">–°–ª–µ–¥—É—é—â–∞—è</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div class="modal fade" id="viewUserModal" tabindex="-1" role="dialog" aria-labelledby="viewUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewUserModalLabel">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>–ü—Ä–æ—Ñ–∏–ª—å</h5>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>ID:</strong></td>
                                <td id="modal-user-id"></td>
                            </tr>
                            <tr>
                                <td><strong>Telegram ID:</strong></td>
                                <td id="modal-telegram-id"></td>
                            </tr>
                            <tr>
                                <td><strong>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong></td>
                                <td id="modal-username"></td>
                            </tr>
                            <tr>
                                <td><strong>–ò–º—è:</strong></td>
                                <td id="modal-first-name"></td>
                            </tr>
                            <tr>
                                <td><strong>–§–∞–º–∏–ª–∏—è:</strong></td>
                                <td id="modal-last-name"></td>
                            </tr>
                            <tr>
                                <td><strong>–Ø–∑—ã–∫:</strong></td>
                                <td id="modal-language"></td>
                            </tr>
                            <tr>
                                <td><strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong></td>
                                <td id="modal-created-at"></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span><strong>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤:</strong></span>
                                <span id="modal-total-orders" class="badge badge-primary badge-pill"></span>
                            </div>
                            <div class="progress mt-1" style="height: 10px;">
                                <div id="modal-orders-progress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span><strong>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤:</strong></span>
                                <span id="modal-total-spent"></span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span><strong>–û—Ç–∑—ã–≤–æ–≤:</strong></span>
                                <span id="modal-reviews-count" class="badge badge-info badge-pill"></span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span><strong>–ë–∞–≥-—Ä–µ–ø–æ—Ä—Ç–æ–≤:</strong></span>
                                <span id="modal-bug-reports-count" class="badge badge-warning badge-pill"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <h5>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered" id="modal-orders-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ë–æ—Ç</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–∞—Ç–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <a id="modal-user-link" href="#" class="btn btn-primary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let usersPerPage = 10;
    let totalUsers = 0;
    let activeFilters = {};

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function loadUserStats() {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ API
        // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        $.get('/users/count', function(data) {
            $('#total-users').text(data.count);

            // –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            const withOrders = Math.round(data.count * 0.6);
            $('#users-with-orders').text(withOrders);

            // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —è–∑—ã–∫–∞–º (–∑–∞–≥–ª—É—à–∫–∞)
            const langRu = 70;
            const langUk = 15;
            const langEn = 10;
            const langOther = 5;

            $('#lang-ru').css('width', langRu + '%')
                         .attr('aria-valuenow', langRu)
                         .text(langRu + '% üá∑üá∫');

            $('#lang-uk').css('width', langUk + '%')
                         .attr('aria-valuenow', langUk)
                         .text(langUk + '% üá∫üá¶');

            $('#lang-en').css('width', langEn + '%')
                         .attr('aria-valuenow', langEn)
                         .text(langEn + '% üá¨üáß');

            $('#lang-other').css('width', langOther + '%')
                           .attr('aria-valuenow', langOther)
                           .text(langOther + '% üåê');
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function loadUsers() {
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞
        var language = $('#filter-language').val();
        var status = $('#filter-status').val();
        var sort = $('#filter-sort').val();
        var search = $('#search-user').val();

        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
        var params = {
            page: currentPage,
            limit: usersPerPage
        };

        if (language) params.language = language;
        if (status) params.status = status;
        if (sort) params.sort = sort;
        if (search) params.search = search;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        activeFilters = {
            language: language,
            status: status,
            sort: sort,
            search: search
        };

        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        $.get('/users', function(data) {
            var tableBody = $('#users-table tbody');
            tableBody.empty();

            if (data.length === 0) {
                tableBody.append('<tr><td colspan="7" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>');
                $('#pagination').hide();
            } else {
                totalUsers = data.length; // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ —ç—Ç–æ –ø—Ä–∏—à–ª–æ –±—ã —Å —Å–µ—Ä–≤–µ—Ä–∞

                data.forEach(function(user) {
                    var username = user.username || '–ù–µ—Ç –∏–º–µ–Ω–∏';
                    var fullname = '';

                    if (user.first_name || user.last_name) {
                        fullname = (user.first_name || '') + ' ' + (user.last_name || '');
                        fullname = `<br><small>${fullname.trim()}</small>`;
                    }

                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–ª–∞–≥ —è–∑—ã–∫–∞
                    var langFlag = '';
                    switch(user.language) {
                        case 'ru': langFlag = 'üá∑üá∫'; break;
                        case 'uk': langFlag = 'üá∫üá¶'; break;
                        case 'en': langFlag = 'üá¨üáß'; break;
                        default: langFlag = 'üåê';
                    }

                    // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–∫–∞–∑–æ–≤ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–æ—Å—å –±—ã —Å —Å–µ—Ä–≤–µ—Ä–∞)
                    var ordersCount = '<span id="orders-count-' + user.id + '">...</span>';

                    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                    // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞
                    setTimeout(function() {
                        const orders = Math.floor(Math.random() * 10); // –°–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                        $('#orders-count-' + user.id).text(orders);
                    }, 500);

                    tableBody.append(`
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.telegram_id}</td>
                            <td>@${username}${fullname}</td>
                            <td>${new Date(user.created_at).toLocaleString()}</td>
                            <td>${langFlag} ${user.language}</td>
                            <td class="text-center">${ordersCount}</td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-info btn-sm view-user" data-id="${user.id}" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="/users/page/${user.id}" class="btn btn-primary btn-sm" title="–î–µ—Ç–∞–ª–∏">
                                        <i class="fas fa-user"></i>
                                    </a>
                                    <button class="btn btn-success btn-sm send-message" data-id="${user.id}" title="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">
                                        <i class="fas fa-envelope"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `);
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
                updatePagination();
                $('#pagination').show();
            }
        });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    function updatePagination() {
        var totalPages = Math.ceil(totalUsers / usersPerPage);
        var pagination = $('#pagination');
        pagination.empty();

        // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
        pagination.append(`
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${currentPage - 1}" ${currentPage === 1 ? 'tabindex="-1" aria-disabled="true"' : ''}>–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
            </li>
        `);

        // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
        for (var i = 1; i <= totalPages; i++) {
            pagination.append(`
                <li class="page-item ${currentPage === i ? 'active' : ''}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>
            `);
        }

        // –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∞—è"
        pagination.append(`
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" data-page="${currentPage + 1}" ${currentPage === totalPages ? 'tabindex="-1" aria-disabled="true"' : ''}>–°–ª–µ–¥—É—é—â–∞—è</a>
            </li>
        `);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function loadUserDetails(userId) {
        $.get('/users/' + userId, function(user) {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            $('#modal-user-id').text(user.id);
            $('#modal-telegram-id').text(user.telegram_id);
            $('#modal-username').text(user.username || '-');
            $('#modal-first-name').text(user.first_name || '-');
            $('#modal-last-name').text(user.last_name || '-');

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–ª–∞–≥ —è–∑—ã–∫–∞
            var langFlag = '';
            switch(user.language) {
                case 'ru': langFlag = 'üá∑üá∫ –†—É—Å—Å–∫–∏–π'; break;
                case 'uk': langFlag = 'üá∫üá¶ –£–∫—Ä–∞–∏–Ω—Å–∫–∏–π'; break;
                case 'en': langFlag = 'üá¨üáß –ê–Ω–≥–ª–∏–π—Å–∫–∏–π'; break;
                default: langFlag = 'üåê ' + user.language;
            }
            $('#modal-language').text(langFlag);

            $('#modal-created-at').text(new Date(user.created_at).toLocaleString());

            // –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥—Ä–æ–±–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            $('#modal-user-link').attr('href', '/users/page/' + user.id);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            $.get('/users/' + userId + '/stats', function(stats) {
                $('#modal-total-orders').text(stats.total_orders);
                $('#modal-total-spent').text(stats.total_spent.toFixed(2) + ' ‚ÇΩ');
                $('#modal-reviews-count').text(stats.reviews_count);
                $('#modal-bug-reports-count').text(stats.bug_reports_count);

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∑–∞–∫–∞–∑–æ–≤ (–º–∞–∫—Å–∏–º—É–º 10 –∑–∞–∫–∞–∑–æ–≤ = 100%)
                var progressPercent = Math.min(stats.total_orders * 10, 100);
                $('#modal-orders-progress').css('width', progressPercent + '%')
                                          .attr('aria-valuenow', progressPercent);
            });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
            $.get('/users/' + userId + '/orders', function(orders) {
                var tableBody = $('#modal-orders-table tbody');
                tableBody.empty();

                if (orders.length === 0) {
                    tableBody.append('<tr><td colspan="5" class="text-center">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</td></tr>');
                } else {
                    orders.slice(0, 5).forEach(function(order) {
                        var statusBadge = '';
                        switch(order.status) {
                            case 'paid':
                                statusBadge = '<span class="badge badge-success">–û–ø–ª–∞—á–µ–Ω</span>';
                                break;
                            case 'pending':
                                statusBadge = '<span class="badge badge-warning">–í –æ–∂–∏–¥–∞–Ω–∏–∏</span>';
                                break;
                            case 'cancelled':
                                statusBadge = '<span class="badge badge-danger">–û—Ç–º–µ–Ω–µ–Ω</span>';
                                break;
                            default:
                                statusBadge = '<span class="badge badge-secondary">' + order.status + '</span>';
                        }

                        tableBody.append(`
                            <tr>
                                <td>${order.id}</td>
                                <td>${order.bot_name}</td>
                                <td>${order.amount.toFixed(2)} ‚ÇΩ</td>
                                <td>${statusBadge}</td>
                                <td>${new Date(order.created_at).toLocaleString()}</td>
                            </tr>
                        `);
                    });

                    if (orders.length > 5) {
                        tableBody.append(`
                            <tr>
                                <td colspan="5" class="text-center">
                                    <a href="/users/page/${userId}" class="btn btn-sm btn-outline-primary">
                                        –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã (${orders.length})
                                    </a>
                                </td>
                            </tr>
                        `);
                    }
                }
            });

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            $('#viewUserModal').modal('show');
        });
    }

    $(document).ready(function() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadUserStats();
        loadUsers();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Ñ–∏–ª—å—Ç—Ä–∞
        $('#filter-form').submit(function(e) {
            e.preventDefault();
            currentPage = 1; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            loadUsers();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        $('#reset-filters').click(function() {
            $('#filter-language').val('');
            $('#filter-status').val('');
            $('#filter-sort').val('newest');
            $('#search-user').val('');
            currentPage = 1;
            loadUsers();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
        $('#search-button').click(function() {
            currentPage = 1;
            loadUsers();
        });

        $('#search-user').keypress(function(e) {
            if (e.which === 13) {
                e.preventDefault();
                currentPage = 1;
                loadUsers();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        $(document).on('click', '#pagination .page-link', function(e) {
            e.preventDefault();
            var page = $(this).data('page');
            if (page && page !== currentPage) {
                currentPage = page;
                loadUsers();
                $('html, body').animate({ scrollTop: 0 }, 'fast');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        $(document).on('click', '.view-user', function() {
            var userId = $(this).data('id');
            loadUserDetails(userId);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        $(document).on('click', '.send-message', function() {
            var userId = $(this).data('id');
            alert('–§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ID:' + userId + ' –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        });
    });
</script>
{% endblock %}