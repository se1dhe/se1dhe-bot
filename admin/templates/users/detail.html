{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {{ user.username or user.first_name }} - SE1DHE Bot Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mt-4">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ user.username or user.first_name }}</h1>
    <div>
        <button id="send-message-btn" class="btn btn-success mr-2">
            <i class="fas fa-envelope"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        </button>
        <a href="/users/page" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h6>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <div class="rounded-circle bg-primary text-white d-inline-flex justify-content-center align-items-center" style="width: 100px; height: 100px; font-size: 36px;">
                        {{ user.first_name[0] if user.first_name else (user.username[0] if user.username else "?") }}
                    </div>
                    <h4 class="mt-3">
                        {{ user.first_name }} {{ user.last_name if user.last_name else "" }}
                        {% if user.username %}
                        <small class="d-block text-muted">@{{ user.username }}</small>
                        {% endif %}
                    </h4>
                </div>

                <div class="mb-3">
                    <strong>ID:</strong> {{ user.id }}
                </div>
                <div class="mb-3">
                    <strong>Telegram ID:</strong> {{ user.telegram_id }}
                </div>
                <div class="mb-3">
                    <strong>–Ø–∑—ã–∫:</strong>
                    {% if user.language == "ru" %}
                        üá∑üá∫ –†—É—Å—Å–∫–∏–π
                    {% elif user.language == "uk" %}
                        üá∫üá¶ –£–∫—Ä–∞–∏–Ω—Å–∫–∏–π
                    {% elif user.language == "en" %}
                        üá¨üáß –ê–Ω–≥–ª–∏–π—Å–∫–∏–π
                    {% else %}
                        üåê {{ user.language }}
                    {% endif %}
                </div>
                <div class="mb-3">
                    <strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong> {{ user.created_at }}
                </div>

                <hr>

                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">–°—Ç–∞—Ç—É—Å:</h6>
                    <span class="badge badge-success">–ê–∫—Ç–∏–≤–Ω—ã–π</span>
                </div>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤:</strong> <span id="total-orders">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div class="mb-3">
                    <strong>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤:</strong> <span id="total-spent">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div class="mb-3">
                    <strong>–û—Ç–∑—ã–≤–æ–≤:</strong> <span id="reviews-count">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div class="mb-3">
                    <strong>–ë–∞–≥-—Ä–µ–ø–æ—Ä—Ç–æ–≤:</strong> <span id="bug-reports-count">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>

                <!-- –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
                <div class="mt-4">
                    <h6>–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–∫–∞–∑–æ–≤:</h6>
                    <div class="progress mb-2">
                        <div id="orders-progress" class="progress-bar bg-primary" role="progressbar"
                             style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            0
                        </div>
                    </div>
                    <small class="text-muted">0-10 –∑–∞–∫–∞–∑–æ–≤ = 100%</small>
                </div>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">–î–µ–π—Å—Ç–≤–∏—è</h6>
            </div>
            <div class="card-body">
                <button id="export-data-btn" class="btn btn-outline-primary btn-block mb-2">
                    <i class="fas fa-file-export"></i> –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                </button>
                <button id="send-notification-btn" class="btn btn-outline-info btn-block mb-2">
                    <i class="fas fa-bell"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                </button>
                <button id="block-user-btn" class="btn btn-outline-danger btn-block">
                    <i class="fas fa-ban"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                </button>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">–ó–∞–∫–∞–∑—ã</h6>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary active" data-filter="all">–í—Å–µ</button>
                    <button type="button" class="btn btn-outline-success" data-filter="paid">–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ</button>
                    <button type="button" class="btn btn-outline-warning" data-filter="pending">–í –æ–∂–∏–¥–∞–Ω–∏–∏</button>
                    <button type="button" class="btn btn-outline-danger" data-filter="cancelled">–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="orders-table" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ë–æ—Ç</th>
                                <th>–°—É–º–º–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">–û—Ç–∑—ã–≤—ã</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="reviews-table" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ë–æ—Ç</th>
                                <th>–†–µ–π—Ç–∏–Ω–≥</th>
                                <th>–¢–µ–∫—Å—Ç</th>
                                <th>–î–∞—Ç–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">–ë–∞–≥-—Ä–µ–ø–æ—Ä—Ç—ã</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="bug-reports-table" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ë–æ—Ç</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–¢–µ–∫—Å—Ç</th>
                                <th>–î–∞—Ç–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è -->
<div class="modal fade" id="sendMessageModal" tabindex="-1" role="dialog" aria-labelledby="sendMessageModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sendMessageModalLabel">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="message-form">
                    <div class="form-group">
                        <label for="message-text">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
                        <textarea class="form-control" id="message-text" rows="5" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="send-message">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        const userId = {{ user.id }};

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        $.get(`/users/${userId}/stats`, function(data) {
            $('#total-orders').text(data.total_orders);
            $('#total-spent').text(data.total_spent.toFixed(2) + ' —Ä—É–±.');
            $('#reviews-count').text(data.reviews_count);
            $('#bug-reports-count').text(data.bug_reports_count);

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            var progressPercent = Math.min(data.total_orders * 10, 100);
            $('#orders-progress').css('width', progressPercent + '%')
                               .attr('aria-valuenow', progressPercent)
                               .text(data.total_orders);
        }).fail(function() {
            $('#total-orders, #total-spent, #reviews-count, #bug-reports-count').text('–û—à–∏–±–∫–∞');
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤
        function loadOrders(filter = 'all') {
            $.get(`/users/${userId}/orders`, function(data) {
                var tableBody = $('#orders-table tbody');
                tableBody.empty();

                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω —Ñ–∏–ª—å—Ç—Ä
                if (filter !== 'all') {
                    data = data.filter(order => order.status === filter);
                }

                if (data.length === 0) {
                    tableBody.append('<tr><td colspan="6" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>');
                } else {
                    data.forEach(function(order) {
                        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
                        let statusBadge = '';
                        switch(order.status) {
                            case 'paid':
                                statusBadge = '<span class="badge badge-success">–û–ø–ª–∞—á–µ–Ω</span>';
                                break;
                            case 'pending':
                                statusBadge = '<span class="badge badge-warning">–í –æ–∂–∏–¥–∞–Ω–∏–∏</span>';
                                break;
                            case 'cancelled':
                                statusBadge = '<span class="badge badge-danger">–û—Ç–º–µ–Ω–µ–Ω</span>';
                                break;
                            default:
                                statusBadge = '<span class="badge badge-secondary">' + order.status + '</span>';
                        }

                        tableBody.append(`
                            <tr>
                                <td>${order.id}</td>
                                <td>${order.bot_name}</td>
                                <td>${order.amount.toFixed(2)} —Ä—É–±.</td>
                                <td>${statusBadge}</td>
                                <td>${new Date(order.created_at).toLocaleString()}</td>
                                <td>
                                    <a href="/payments/page/${order.id}" class="btn btn-info btn-sm">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                        `);
                    });
                }
            }).fail(function() {
                $('#orders-table tbody').html('<tr><td colspan="6" class="text-center text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>');
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤
        $.get(`/users/${userId}/reviews`, function(data) {
            var tableBody = $('#reviews-table tbody');
            tableBody.empty();

            if (data.length === 0) {
                tableBody.append('<tr><td colspan="5" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>');
            } else {
                data.forEach(function(review) {
                    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞ –∑–≤–µ–∑–¥–∞–º–∏
                    var stars = '';
                    for (var i = 1; i <= 5; i++) {
                        stars += i <= review.rating ? '‚òÖ' : '‚òÜ';
                    }

                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞
                    var text = review.text || '(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)';
                    if (text.length > 100) {
                        text = text.substring(0, 100) + '...';
                    }

                    tableBody.append(`
                        <tr>
                            <td>${review.id}</td>
                            <td>${review.bot_name}</td>
                            <td><span class="text-warning">${stars}</span> ${review.rating}/5</td>
                            <td>${text}</td>
                            <td>${new Date(review.created_at).toLocaleString()}</td>
                        </tr>
                    `);
                });
            }
        }).fail(function() {
            $('#reviews-table tbody').html('<tr><td colspan="5" class="text-center text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>');
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–≥-—Ä–µ–ø–æ—Ä—Ç–æ–≤
        $.get(`/users/${userId}/bug_reports`, function(data) {
            var tableBody = $('#bug-reports-table tbody');
            tableBody.empty();

            if (data.length === 0) {
                tableBody.append('<tr><td colspan="5" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>');
            } else {
                data.forEach(function(report) {
                    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
                    let statusClass = 'badge badge-';
                    let statusText = '';
                    switch(report.status) {
                        case 'new':
                            statusClass += 'warning';
                            statusText = '–ù–æ–≤—ã–π';
                            break;
                        case 'in_progress':
                            statusClass += 'info';
                            statusText = '–í —Ä–∞–±–æ—Ç–µ';
                            break;
                        case 'resolved':
                            statusClass += 'success';
                            statusText = '–†–µ—à–µ–Ω';
                            break;
                        default:
                            statusClass += 'secondary';
                            statusText = report.status;
                    }

                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞
                    var text = report.text;
                    if (text.length > 100) {
                        text = text.substring(0, 100) + '...';
                    }

                    tableBody.append(`
                        <tr>
                            <td>${report.id}</td>
                            <td>${report.bot_name}</td>
                            <td><span class="${statusClass}">${statusText}</span></td>
                            <td>${text}</td>
                            <td>${new Date(report.created_at).toLocaleString()}</td>
                        </tr>
                    `);
                });
            }
        }).fail(function() {
            $('#bug-reports-table tbody').html('<tr><td colspan="5" class="text-center text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>');
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadOrders();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–∫–∞–∑–æ–≤
        $('.btn-group[data-toggle="buttons"] .btn').click(function() {
            $('.btn-group[data-toggle="buttons"] .btn').removeClass('active');
            $(this).addClass('active');
            loadOrders($(this).data('filter'));
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        $('.card-header .btn-group .btn').click(function() {
            $(this).siblings().removeClass('active');
            $(this).addClass('active');
            loadOrders($(this).data('filter'));
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        $('#send-message-btn').click(function() {
            $('#sendMessageModal').modal('show');
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        $('#send-message').click(function() {
            var message = $('#message-text').val().trim();
            if (!message) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è!');
                return;
            }

            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã AJAX-–∑–∞–ø—Ä–æ—Å
            alert('–°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {{ user.username or user.first_name }}');
            $('#sendMessageModal').modal('hide');
            $('#message-text').val('');
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
        $('#export-data-btn').click(function() {
            alert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        });

        $('#send-notification-btn').click(function() {
            alert('–§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        });

        $('#block-user-btn').click(function() {
            if (confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ user.username or user.first_name }}?')) {
                alert('–§—É–Ω–∫—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
            }
        });
    });
</script>
{% endblock %}